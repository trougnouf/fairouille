name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 1. Install System Dependencies
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev

      # 2. Run Tests
      - name: Run Unit Tests
        run: cargo test --verbose

      # 3. Install Packaging Tools
      - name: Install cargo-deb
        run: cargo install cargo-deb

      # 4. Build Release Binaries (Standard)
      - name: Build Release
        run: cargo build --release --features gui

      # 5. Build Debian Package (.deb)
      - name: Build Deb
        run: cargo deb --no-build --features gui 

      # 6. Package Generic Linux Tarball
      - name: Create Archive
        run: |
          STAGING="cfait-${{ github.ref_name }}"
          mkdir -p "$STAGING"

          # Copy Binaries (Renaming gui -> cfait-gui)
          cp target/release/cfait "$STAGING/"
          cp target/release/gui "$STAGING/cfait-gui"
          
          # Assets
          cp README.md LICENSE "$STAGING/"
          cp assets/cfait.desktop "$STAGING/"
          cp assets/cfait.svg "$STAGING/"

          # Compress
          tar -czvf "cfait-linux-${{ github.ref_name }}.tar.gz" "$STAGING"

      # 7. Generate Changelog (Manual Binary Install to fix Docker error)
      - name: Generate Changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Download the latest git-cliff release asset for Linux
          gh release download --repo orhun/git-cliff --pattern '*x86_64-unknown-linux-gnu.tar.gz'

          # Extract the archive
          tar -xf git-cliff-*.tar.gz

          # Move the binary to the current directory and make it executable
          mv git-cliff-*/git-cliff .
          chmod +x ./git-cliff

          # Run git-cliff to generate the changelog
          ./git-cliff --config cliff.toml --verbose --latest --strip header --output CHANGELOG_RELEASE.md

      # 8. Publish to GitHub Releases
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: CHANGELOG_RELEASE.md
          files: |
            cfait-linux-${{ github.ref_name }}.tar.gz
            target/debian/*.deb

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Release
        run: cargo build --release --features gui

      - name: Create Archive
        run: |
          New-Item -ItemType Directory -Force -Path "staging"
          
          # Copy Binaries
          Copy-Item "target\release\cfait.exe" -Destination "staging\"
          Copy-Item "target\release\gui.exe" -Destination "staging\cfait-gui.exe"
          
          # Copy Docs
          Copy-Item "README.md" -Destination "staging\"
          Copy-Item "LICENSE" -Destination "staging\"
          
          # Create Zip
          Compress-Archive -Path "staging\*" -DestinationPath "cfait-windows-${{ github.ref_name }}.zip"

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: cfait-windows-${{ github.ref_name }}.zip

  package-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate Production PKGBUILD
        run: |
          VERSION=${{ github.ref_name }}
          SOURCE_URL="https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.tar.gz"
          
          wget -O source.tar.gz "$SOURCE_URL"
          
          HASH=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "Calculated Hash: $HASH"
          
          sed -i "s/'SKIP'/'$HASH'/" packaging/arch/PKGBUILD
          cp packaging/arch/PKGBUILD PKGBUILD-release

      - name: Upload PKGBUILD to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PKGBUILD-release